using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ConnectKsmcDAL.Report
{
   public class R13021DAL:CommonDAL
    {
        public DataTable GetHeaderData(string siteCode)
        {
            return ReportQuery($@"SELECT T_SITE_CODE , T_COUNTRY_LANG1_NAME , T_COUNTRY_LANG2_NAME , T_MIN_LANG1_NAME , T_MIN_LANG2_NAME , T_SITE_LANG1_NAME , T_SITE_LANG2_NAME , T_LOGO_ID , T_LOGO_NAME , T_LOGO , T_LCENCE_NO FROM t01028 WHERE T_SITE_CODE IN(SELECT T_SITE_CODE FROM t01001)");
        }
        public DataTable GetReportData(string reqNo)
        {
            return ReportQuery($@"SELECT T_1.*,T_1.T_RANGE_FROM ||'-'||T_1.T_RANGE_TO T_RANGE, (CASE WHEN TO_NUMBER( T_1.T_RESULT_VALUE) < TO_NUMBER(T_1.T_RANGE_FROM)THEN 'Low' WHEN TO_NUMBER( T_1.T_RESULT_VALUE) >TO_NUMBER(T_1.T_RANGE_TO)THEN 'High' ELSE '' END )T_RANGE_DES FROM ( SELECT T13018.T_ANALYSIS_CODE , T13018.T_REQUEST_NO , T13018.T_RESULT_VALUE , (CASE WHEN T13018.T_ANALYSIS_CODE in ('2816','02023') THEN (select t_lang2_name from t13006 where t_result_code = T13018.T_RESULT_VALUE ) ELSE T13018.T_RESULT_VALUE END ) RESULT_UM, T13018.T_SPECIMEN_NO , T13018.T_STAFF_CODE , T13018.T_WS_CODE , T13018.T_NOTES , T13018.T_CLOSE_FLAG , (SELECT MAX(T_LAB_NO) FROM T13017 WHERE T_REQUEST_NO = T13018.T_REQUEST_NO AND T_WS_CODE = '02' AND T_LAB_NO IS NOT NULL)T_LAB_NO, T13018.T_ANALYZER_ID , T13018.T_UPD_DATE, T13015.T_PAT_NO P_NO , T13015.T_EXTERNAL_FLAG E_FLAG, T13011.T_LANG2_NAME ANALYSIS, T13011.T_RESULT_TYPE , DECODE(T13011.t_result_type, '1', (SELECT T_NR_FROM FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T13014.T_WS_CODE = T13018.T_WS_CODE AND T13014.T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE), '2', (SELECT T_NR_FROM FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T13014.T_WS_CODE = T13018.T_WS_CODE AND T13014.T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE AND T13014.T_GENDER =NVL( T01.T_GENDER ,T03.T_GENDER)), '3', (SELECT T_NR_FROM FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T_WS_CODE = T13018.T_WS_CODE AND T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE AND TO_NUMBER(NVL(TRUNC(MONTHS_BETWEEN(SYSDATE,NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))/12,0),0) * 365) + TRUNC(SYSDATE)-(ADD_MONTHS(NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE), (TRUNC((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE)))/12))*12+(MOD((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))), 12)))) BETWEEN ((T_YEAR_FROM*365 ) + T_DAYS_FROM) AND ((T_YEAR_TO*365) + T_DAYS_TO)), '4', (SELECT T_NR_FROM FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T_WS_CODE = T13018.T_WS_CODE AND T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE AND TO_NUMBER(NVL(TRUNC(MONTHS_BETWEEN(SYSDATE,NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))/12,0),0) * 365) + TRUNC(SYSDATE)-(ADD_MONTHS(NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE), (TRUNC((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE)))/12))*12+(MOD((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))), 12)))) BETWEEN ((T_YEAR_FROM*365 ) + T_DAYS_FROM) AND ((T_YEAR_TO*365) + T_DAYS_TO) AND T_GENDER = NVL( T01.T_GENDER,T03.T_GENDER)), (SELECT DISTINCT T_NR_FROM FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'05') AND T_WS_CODE=T13018.T_WS_CODE AND T_ANALYSIS_CODE=T13018.T_ANALYSIS_CODE)) T_RANGE_FROM, DECODE(T13011.t_result_type, '1', (SELECT T_NR_TO FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T13014.T_WS_CODE = T13018.T_WS_CODE AND T13014.T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE), '2', (SELECT T_NR_TO FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T13014.T_WS_CODE = T13018.T_WS_CODE AND T13014.T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE AND T13014.T_GENDER =NVL( T01.T_GENDER ,T03.T_GENDER)), '3', (SELECT T_NR_TO FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T_WS_CODE = T13018.T_WS_CODE AND T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE AND TO_NUMBER(NVL(TRUNC(MONTHS_BETWEEN(SYSDATE,NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))/12,0),0) * 365) + TRUNC(SYSDATE)-(ADD_MONTHS(NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE), (TRUNC((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE)))/12))*12+(MOD((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))), 12)))) BETWEEN ((T_YEAR_FROM*365 ) + T_DAYS_FROM) AND ((T_YEAR_TO*365) + T_DAYS_TO)), '4', (SELECT T_NR_TO FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T_WS_CODE = T13018.T_WS_CODE AND T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE AND TO_NUMBER(NVL(TRUNC(MONTHS_BETWEEN(SYSDATE,NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))/12,0),0) * 365) + TRUNC(SYSDATE)-(ADD_MONTHS(NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE), (TRUNC((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE)))/12))*12+(MOD((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))), 12)))) BETWEEN ((T_YEAR_FROM*365 ) + T_DAYS_FROM) AND ((T_YEAR_TO*365) + T_DAYS_TO) AND T_GENDER = NVL( T01.T_GENDER,T03.T_GENDER)), (SELECT DISTINCT T_NR_TO FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'05') AND T_WS_CODE=T13018.T_WS_CODE AND T_ANALYSIS_CODE=T13018.T_ANALYSIS_CODE)) T_RANGE_TO, T13011.T_UM UNITS FROM T13011,T13018,T13015,T03001 t01,T03003 t03 WHERE T13018.T_REQUEST_NO = '{reqNo}' AND T13018.T_WS_CODE = '02' AND T13015.T_PAT_NO =T01.T_PAT_NO (+) AND T13015.T_PAT_NO =T03.T_TMP_PAT_NO (+) AND T13015.T_REQUEST_NO = T13018.T_REQUEST_NO AND T13011.T_WS_CODE = T13018.T_WS_CODE AND T13011.T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE AND T13018.T_CLOSE_FLAG IS NOT NULL ORDER BY T_ANALYSIS_SEQ,T_ANALYSIS_CODE)T_1 ");
        }
        public DataTable GetPatientInfo(string reqNo)
        {
            return ReportQuery($@"SELECT T13015.T_LOCATION_CODE , T13015.T_PAT_NO , (CASE WHEN T13015.T_EXTERNAL_FLAG IS NULL THEN ( LTRIM (RTRIM(T03001.T_FIRST_LANG2_NAME)) ||' '|| LTRIM(RTRIM(T03001.T_FATHER_LANG2_NAME)) ||' '|| LTRIM(RTRIM( T03001.T_GFATHER_LANG2_NAME))||' '|| LTRIM(RTRIM(T03001.T_FAMILY_LANG2_NAME)) ) ELSE( LTRIM (RTRIM(T03003.T_FIRST_LANG2_NAME)) ||' '|| LTRIM(RTRIM(T03003.T_FATHER_LANG2_NAME)) ||' '|| LTRIM(RTRIM( T03003.T_GFATHER_LANG2_NAME))||' '|| LTRIM(RTRIM(T03003.T_FAMILY_LANG2_NAME))) END ) PAT_NAME_ENG, (CASE WHEN T13015.T_EXTERNAL_FLAG IS NULL THEN(SELECT t_lang2_name FROM T02003 WHERE T_NTNLTY_CODE = T03001.T_NTNLTY_CODE) ELSE( SELECT t_lang2_name FROM T02003 WHERE T_NTNLTY_CODE = T03003.T_NTNLTY_CODE) END )NTNLTY_NAME, (CASE WHEN T13015.T_EXTERNAL_FLAG IS NULL THEN (select t_lang2_name from t02006 where t_sex_code = T03001.T_GENDER )ELSE (select t_lang2_name from t02006 where t_sex_code = T03003.T_GENDER) END )GENDER_NAME, (CASE WHEN T13015.T_EXTERNAL_FLAG IS NULL THEN NVL(T03001.T_X_RMC_CHRTNO,T03001.T_X_HOSP1_PAT_NO) ELSE ''END )HOSP_NO, T13015.T_PAT_TYPE , T13015.T_PRIORITY_CODE , T13015.T_REQUEST_DATE , T13015.T_REQUEST_NO REQUEST_NO , T13015.T_COMMENT_LINE T_CLINIC_DATA , T13015.T_SPEC_NO , SUBSTR(T13015.T_REQUEST_TIME,1,2) || ' :' || SUBSTR(T13015.T_REQUEST_TIME,3,2) REQUEST_TIME , T13015.T_EXTERNAL_FLAG , doctor_name(T13015.t_doc_code ) PHYSICIAN_NAME, ( select t_user_name from t01009 where t_emp_code =(select max(t_upd_user) from t13018 where t_request_no = '{reqNo}' and t_ws_code ='02' and t_result_value is not null and nvl(t_upd_seq,0) in ( select nvl(max(t_upd_seq),0) from t13018 where t_request_no = '{reqNo}' and t_ws_code ='02' and t_result_value is not null)))reported_by, (SELECT t_lang2_name FROM t13005 WHERE t_specimen_code = (SELECT max(t_specimen_code) FROM t13017 WHERE t_request_no ='{reqNo}' AND t_ws_code = '02' AND t_received_date is not null)) SPECIMEN, (SELECT T_USER_NAME FROM T01009 WHERE T_EMP_CODE =( SELECT max(t_staff_code) FROM t13017 WHERE t_request_no ='{reqNo}' AND t_ws_code = '02' AND t_received_date is not null) )TECHONOLOGIST, (select decode(t_hosp_code,'1','Central Lab','2','Medical Lab','3','KSMC Lab','4','ER Lab','5','AKU Lab') from t13019 where t_emp_code = ( SELECT max(t_staff_code) FROM t13017 WHERE t_request_no ='{reqNo}' AND t_ws_code = '02' AND t_received_date is not null)) LAB_LOCATION, (select nvl(t_hosp_code,'1') from t13019 where t_emp_code = ( SELECT max(t_staff_code) FROM t13017 WHERE t_request_no ='{reqNo}' AND t_ws_code = '02' AND t_received_date is not null)) hosp_code, (SELECT to_char( max(t_received_date),'dd/mm/yyyy' ) || ' '|| max(t_received_time) FROM t13017 WHERE t_request_no ='{reqNo}' AND t_ws_code = '02' AND t_received_date is not null) received_date_time, (SELECT to_char( max(t_collection_date),'dd/mm/yyyy' ) || ' '||max(t_collection_time) FROM t13017 WHERE t_request_no ='{reqNo}' AND t_ws_code = '02' AND t_received_date is not null) collection_date_time, (select to_char( max(t_upd_date),'dd/mm/yyyy' ) from t13018 where t_request_no ='{reqNo}' and t_ws_code='02' and t_close_flag is not null) || ' ' ||(select max(t_analysis_time) from t13018 where t_request_no = '{reqNo}' and t_ws_code='02' and t_close_flag is not null and t_upd_date =(select max(t_upd_date) from t13018 where t_request_no ='{reqNo}' and t_ws_code='02' and t_close_flag is not null)) upd_date_time, ( CASE WHEN T13015.T_EXTERNAL_FLAG IS NULL THEN ( TRUNC ( ((select max(t_upd_date) from t13018 where t_request_no='{reqNo}' and t_ws_code='02' and t_close_flag is not null)-T03001.T_BIRTH_DATE)/365,0) || ' ' || 'Y' || ' ' || TRUNC(MOD(MONTHS_BETWEEN((select max(t_upd_date) from t13018 where t_request_no='{reqNo}' and t_ws_code='02' and t_close_flag is not null),T03001.T_BIRTH_DATE), 12), 0) || ' ' ||'M' || ' ' || TRUNC (((select max(t_upd_date) from t13018 where t_request_no='{reqNo}' and t_ws_code='02' and t_close_flag is not null)) - add_months( T03001.T_BIRTH_DATE,TRUNC(months_between(TRUNC((select max(t_upd_date) from t13018 where t_request_no='{reqNo}' and t_ws_code='02' and t_close_flag is not null)),T03001.T_BIRTH_DATE)))) ||' ' ||'D' ) ELSE ( TRUNC ( ((select max(t_upd_date) from t13018 where t_request_no='{reqNo}' and t_ws_code='02' and t_close_flag is not null)-T03003.T_BIRTH_DATE)/365,0) || ' ' || 'Y' ||' ' || TRUNC(MOD(MONTHS_BETWEEN((select max(t_upd_date) from t13018 where t_request_no='{reqNo}' and t_ws_code='02' and t_close_flag is not null),T03003.T_BIRTH_DATE), 12), 0) || ' ' ||'M' || ' ' || TRUNC (((select max(t_upd_date) from t13018 where t_request_no='{reqNo}' and t_ws_code='02' and t_close_flag is not null)) - add_months( T03003.T_BIRTH_DATE,TRUNC(months_between(TRUNC((select max(t_upd_date) from t13018 where t_request_no='{reqNo}' and t_ws_code='02' and t_close_flag is not null)),T03003.T_BIRTH_DATE)))) ||' ' ||'D' ) END ) T_AGE, (select t_lang2_name  	  	from t13049  	where t_analyzer_id = (select max(t_analyzer_id)    from t13018  where t_request_no = '{reqNo}'   and t_ws_code ='02'   and t_analyzer_id is not null))analyzer FROM T13015 LEFT JOIN T03001 ON T13015.T_PAT_NO =T03001.T_PAT_NO LEFT JOIN T03003 ON T13015.T_PAT_NO =T03003.T_TMP_PAT_NO WHERE T13015.T_REQUEST_NO = '{reqNo}' ");
        }
    }
}

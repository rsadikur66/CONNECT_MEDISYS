using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ConnectKsmcDAL.Report
{
   public class R13111DAL :CommonDAL
    {
        public DataTable GetHeaderData(string siteCode)
        {
            return ReportQuery($@"SELECT T_SITE_CODE , T_COUNTRY_LANG1_NAME , T_COUNTRY_LANG2_NAME , T_MIN_LANG1_NAME , T_MIN_LANG2_NAME , T_SITE_LANG1_NAME , T_SITE_LANG2_NAME , T_LOGO_ID , T_LOGO_NAME , T_LOGO , T_LCENCE_NO FROM t01028 WHERE T_SITE_CODE IN(SELECT T_SITE_CODE FROM t01001)");
        }
        public DataTable GetReportData(string reqNo)
        {
            return ReportQuery($@"SELECT T_1.*, (CASE WHEN T_1.T_RANGE_FROM IS NULL AND T_1.T_RANGE_TO IS NOT NULL THEN (' < ' || T_1.T_RANGE_TO ||' ' || T_1.UNITS) WHEN T_1.T_RANGE_FROM IS NOT NULL AND T_1.T_RANGE_TO IS NOT NULL THEN (T_1.T_RANGE_FROM ||'-' ||T_1.T_RANGE_TO ||' ' || T_1.UNITS) WHEN T_1.T_RANGE_FROM IS NOT NULL AND T_1.T_RANGE_TO IS NULL THEN (' > ' || T_1.T_RANGE_FROM ||' ' || T_1.UNITS) ELSE(T_1.T_RANGE_FROM ||'-' ||T_1.T_RANGE_TO ||' ' || T_1.UNITS) END ) T_RANGE, ( CASE WHEN TO_NUMBER( T_1.T_RESULT_VALUE) < TO_NUMBER(T_1.T_RANGE_FROM) THEN 'Low' WHEN TO_NUMBER( T_1.T_RESULT_VALUE) >TO_NUMBER(T_1.T_RANGE_TO) THEN 'High' ELSE '' END )T_RANGE_DES FROM ( SELECT NVL(T13018.T_UPD_USER,T13018.T_ENTRY_USER) USER_CODE , (SELECT t_user_name FROM t01009 where t_emp_code = NVL(T13018.T_UPD_USER,T13018.T_ENTRY_USER))user_name, T13018.T_ANALYSIS_CODE , T13018.T_REQUEST_NO , T13018.T_RESULT_VALUE , T13018.T_SPECIMEN_NO , T13018.T_STAFF_CODE , T13018.T_WS_CODE , T13018.T_NOTES , T13018.T_CLOSE_FLAG , T13018.T_ANALYZER_ID , T13015.T_PAT_NO P_NO , T13015.T_EXTERNAL_FLAG E_FLAG, T13011.T_LANG2_NAME ANALYSIS, T13011.T_RESULT_TYPE RESULT_TYPE, DECODE(T13011.t_result_type, '1', (SELECT T_NR_FROM FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T13014.T_WS_CODE = T13018.T_WS_CODE AND T13014.T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE ), '2', (SELECT T_NR_FROM FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T13014.T_WS_CODE = T13018.T_WS_CODE AND T13014.T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE AND T13014.T_GENDER =NVL( T01.T_GENDER ,T03.T_GENDER) ), '3', (SELECT T_NR_FROM FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T_WS_CODE = T13018.T_WS_CODE AND T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE AND TO_NUMBER(NVL(TRUNC(MONTHS_BETWEEN(SYSDATE,NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))/12,0),0) * 365) + TRUNC(SYSDATE)-(ADD_MONTHS(NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE), (TRUNC((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE)))/12))*12+(MOD((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))), 12)))) BETWEEN ((T_YEAR_FROM*365 ) + T_DAYS_FROM) AND ((T_YEAR_TO*365) + T_DAYS_TO) ), '4', (SELECT T_NR_FROM FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T_WS_CODE = T13018.T_WS_CODE AND T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE AND TO_NUMBER(NVL(TRUNC(MONTHS_BETWEEN(SYSDATE,NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))/12,0),0) * 365) + TRUNC(SYSDATE)-(ADD_MONTHS(NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE), (TRUNC((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE)))/12))*12+(MOD((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))), 12)))) BETWEEN ((T_YEAR_FROM*365 ) + T_DAYS_FROM) AND ((T_YEAR_TO*365) + T_DAYS_TO) AND T_GENDER = NVL( T01.T_GENDER,T03.T_GENDER) ), (SELECT DISTINCT T_NR_FROM FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'05') AND T_WS_CODE =T13018.T_WS_CODE AND T_ANALYSIS_CODE =T13018.T_ANALYSIS_CODE )) T_RANGE_FROM, DECODE(T13011.t_result_type, '1', (SELECT T_NR_TO FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T13014.T_WS_CODE = T13018.T_WS_CODE AND T13014.T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE ), '2', (SELECT T_NR_TO FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T13014.T_WS_CODE = T13018.T_WS_CODE AND T13014.T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE AND T13014.T_GENDER =NVL( T01.T_GENDER ,T03.T_GENDER) ), '3', (SELECT T_NR_TO FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T_WS_CODE = T13018.T_WS_CODE AND T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE AND TO_NUMBER(NVL(TRUNC(MONTHS_BETWEEN(SYSDATE,NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))/12,0),0) * 365) + TRUNC(SYSDATE)-(ADD_MONTHS(NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE), (TRUNC((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE)))/12))*12+(MOD((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))), 12)))) BETWEEN ((T_YEAR_FROM*365 ) + T_DAYS_FROM) AND ((T_YEAR_TO*365) + T_DAYS_TO) ), '4', (SELECT T_NR_TO FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'02') AND T_WS_CODE = T13018.T_WS_CODE AND T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE AND TO_NUMBER(NVL(TRUNC(MONTHS_BETWEEN(SYSDATE,NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))/12,0),0) * 365) + TRUNC(SYSDATE)-(ADD_MONTHS(NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE), (TRUNC((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE)))/12))*12+(MOD((MONTHS_BETWEEN(TRUNC(SYSDATE), NVL(T01.T_BIRTH_DATE,T03.T_BIRTH_DATE))), 12)))) BETWEEN ((T_YEAR_FROM*365 ) + T_DAYS_FROM) AND ((T_YEAR_TO*365) + T_DAYS_TO) AND T_GENDER = NVL( T01.T_GENDER,T03.T_GENDER) ), (SELECT DISTINCT T_NR_TO FROM T13014 WHERE T_ANALYZER_ID = NVL(T13018.T_ANALYZER_ID,'05') AND T_WS_CODE =T13018.T_WS_CODE AND T_ANALYSIS_CODE =T13018.T_ANALYSIS_CODE )) T_RANGE_TO, (SELECT t_lang2_name FROM t13006 WHERE t_result_code = T13018.T_RESULT_VALUE ) RESULT_UM, T13011.T_UM UNITS FROM T13011,T13018,T13015, T03001 t01, T03003 t03 WHERE T13018.T_REQUEST_NO = '{reqNo}' AND T13018.T_WS_CODE = '11' AND T13015.T_PAT_NO =T01.T_PAT_NO (+) AND T13015.T_PAT_NO =T03.T_TMP_PAT_NO (+) AND T13015.T_REQUEST_NO = T13018.T_REQUEST_NO AND T13011.T_WS_CODE = T13018.T_WS_CODE AND T13011.T_ANALYSIS_CODE = T13018.T_ANALYSIS_CODE AND T13018.T_CLOSE_FLAG IS NOT NULL ORDER BY T_ANALYSIS_SEQ,T_ANALYSIS_CODE )T_1");
        }
        public DataTable GetPatientInfo(string reqNo)
        {
            return ReportQuery($@"SELECT T_LOCATION_CODE , T13015.T_PAT_NO , T_PAT_TYPE , T_PRIORITY_CODE , T_REQUEST_DATE , T13015.T_REQUEST_NO REQUEST_NO , T13015.T_comment_line , trunc(months_between(sysdate,NVL(T03001.T_BIRTH_DATE,T03003.T_BIRTH_DATE)) / 12) || ' '|| 'Y' || ' '|| trunc(months_between(sysdate,NVL(T03001.T_BIRTH_DATE,T03003.T_BIRTH_DATE)) - (trunc(months_between(sysdate,NVL(T03001.T_BIRTH_DATE,T03003.T_BIRTH_DATE)) / 12) * 12))|| ' '|| 'M' || ' '|| trunc((sysdate) - add_months(NVL(T03001.T_BIRTH_DATE,T03003.T_BIRTH_DATE), trunc(months_between(sysdate,NVL(T03001.T_BIRTH_DATE,T03003.T_BIRTH_DATE)))) )|| ' ' || 'D' T_AGE, T_SPEC_NO , SUBSTR(T_REQUEST_TIME,1,2) || ' :' || SUBSTR(T_REQUEST_TIME,3,2) T_REQUEST_TIME , T_EXTERNAL_FLAG , ( SELECT max(T_LAB_NO) FROM T13017 WHERE T_REQUEST_NO ='{reqNo}' AND T_WS_CODE = '11' AND T_LAB_NO IS NOT NULL) T_LAB_NO, ( SELECT max(T_SPECIMEN_CODE) FROM T13017 WHERE T_REQUEST_NO ='{reqNo}' AND T_WS_CODE = '11' AND T_LAB_NO IS NOT NULL) T_SPECIMEN_CODE, ( SELECT max(t_received_date) || ' ' || max(t_received_time) FROM T13017 WHERE T_REQUEST_NO ='{reqNo}' AND T_WS_CODE = '11' AND T_LAB_NO IS NOT NULL) t_received_date_time, ( SELECT max(t_staff_code) FROM T13017 WHERE T_REQUEST_NO ='{reqNo}' AND T_WS_CODE = '11' AND T_LAB_NO IS NOT NULL) t_staff_code, ( SELECT max(t_collection_Date) || ' ' ||max(t_collection_time) FROM T13017 WHERE T_REQUEST_NO ='{reqNo}' AND T_WS_CODE = '11' AND T_LAB_NO IS NOT NULL) t_collection_Date_time, (select t_lang2_name from t02042 where t_loc_code = T13015.T_LOCATION_CODE)T_LOCATION_DES, (NVL((LTRIM(RTRIM(T03001.T_FIRST_LANG2_NAME)) ||' '|| LTRIM(RTRIM(T03001.T_FATHER_LANG2_NAME)) ||' '|| LTRIM(RTRIM( T03001.T_GFATHER_LANG2_NAME))||' '|| LTRIM(RTRIM(T03001.T_FAMILY_LANG2_NAME))),(LTRIM(RTRIM(T03003.T_FIRST_LANG2_NAME)) ||' '|| LTRIM(RTRIM(T03003.T_FATHER_LANG2_NAME)) ||' '|| LTRIM(RTRIM( T03003.T_GFATHER_LANG2_NAME))||' '|| LTRIM(RTRIM(T03003.T_FAMILY_LANG2_NAME)))) )PAT_NAME, NVL(T03001.T_X_RMC_CHRTNO,T03001.T_X_HOSP1_PAT_NO) HOSP_NO, (SELECT T_LANG2_NAME FROM T02003 WHERE T02003.T_NTNLTY_CODE = NVL(T03001.T_NTNLTY_CODE,T03001.T_NTNLTY_CODE)) T_NTNLTY, (SELECT T_LANG2_NAME FROM T02006 WHERE T02006.T_SEX_CODE = NVL(T03001.T_GENDER,T03001.T_GENDER)) T_GENDER_DES, (SELECT t_user_name FROM t01009 WHERE t_emp_code = (SELECT MAX(t_upd_user) FROM t13018 WHERE t_request_no = '{reqNo}' AND t_ws_code ='11' AND t_close_flag IS NOT NULL AND NVL(t_upd_seq,0) IN (SELECT NVL(MAX(t_upd_seq),0) FROM t13018 WHERE t_request_no = '{reqNo}' AND t_ws_code ='11' AND t_close_flag IS NOT NULL ) ) )reported_by, (SELECT t_lang2_name FROM t13005 WHERE t_specimen_code = (SELECT MAX(t_specimen_code) FROM t13017 WHERE t_request_no ='{reqNo}' AND t_ws_code = '11' AND T_LAB_NO IS NOT NULL ) ) SPECIMEN,(SELECT TO_CHAR( MAX(t_upd_date),'dd/mm/yyyy') FROM t13018 WHERE t_request_no = '{reqNo}' AND t_ws_code ='11' AND t_close_flag IS NOT NULL ) UP_DATE, (SELECT T_USER_NAME FROM T01009 WHERE T_EMP_CODE = (SELECT MAX(t_staff_code) FROM t13017 WHERE t_request_no ='{reqNo}' AND t_ws_code = '11' AND T_LAB_NO IS NOT NULL ) )TECHONOLOGIST FROM T13015 LEFT JOIN T03001 ON T13015.T_PAT_NO =T03001.T_PAT_NO LEFT JOIN T03003 ON T13015.T_PAT_NO =T03003.T_TMP_PAT_NO WHERE T13015.T_REQUEST_NO = '{reqNo}' ");
        }
    }
}

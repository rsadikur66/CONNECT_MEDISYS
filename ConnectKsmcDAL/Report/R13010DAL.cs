using System.Data;

namespace ConnectKsmcDAL.Report
{
    public class R13010DAL:CommonDAL
    {
      
        public DataTable GetHeaderData(string siteCode)
        {
            return ReportQuery($@"SELECT T_SITE_CODE , T_COUNTRY_LANG1_NAME , T_COUNTRY_LANG2_NAME , T_MIN_LANG1_NAME , T_MIN_LANG2_NAME , T_SITE_LANG1_NAME , T_SITE_LANG2_NAME , T_LOGO_ID , T_LOGO_NAME , T_LOGO , T_LCENCE_NO FROM t01028 WHERE T_SITE_CODE IN(SELECT T_SITE_CODE FROM t01001)");
        }
        public DataTable GetMasterData(string reqNo)
        {
            return ReportQuery($@"SELECT T_GROUP_MAIN, T_GROUP_NAME, ( CASE WHEN T_GROUP_MAIN ='2' THEN 'Microscopic' ELSE '' END )GROUP_MAIN_DES, T_GROUP_ANALYSIS , T13018.T_WS_CODE, T13018.T_ANALYSIS_CODE, T13018.T_RESULT_VALUE, T_LANG2_NAME , T_NOTES, (SELECT T_RESULT_VALUE ||' ' ||T_NOTES corr_result FROM T13018 WHERE T_REQUEST_NO = '{reqNo}' AND T_ANALYSIS_CODE ='9999' AND T_NOTES IS NOT NULL AND T_WS_CODE = '10' ) corr_result, (SELECT T_NOTES FROM T13018 WHERE T_REQUEST_NO = '{reqNo}' AND T_ANALYSIS_CODE BETWEEN '10039' AND '10085' AND T_NOTES IS NOT NULL AND T_WS_CODE = '10' ) NOTES, ( CASE WHEN (SELECT T_NOTES FROM T13018 WHERE T_REQUEST_NO ='{reqNo}' AND T_ANALYSIS_CODE BETWEEN '10039' AND '10085' AND T_NOTES IS NOT NULL AND T_WS_CODE = '10') IS NOT NULL THEN 'Comments :' ELSE '' END )NOTES_LABEL, (SELECT t_um FROM t13011 WHERE t_analysis_code = T13018.T_ANALYSIS_CODE AND t_ws_code = '10' ) UNITS, ( CASE WHEN (SELECT t_lang2_name FROM t13006 WHERE t_RESULT_CODE = T13018.T_RESULT_VALUE) IS NOT NULL THEN (SELECT t_lang2_name FROM t13006 WHERE t_RESULT_CODE = T13018.T_RESULT_VALUE ) || ' ' || (SELECT t_um FROM t13011 WHERE t_analysis_code = T13018.T_ANALYSIS_CODE AND t_ws_code = '10' ) ELSE T13018.T_RESULT_VALUE || ' ' || (SELECT t_um FROM t13011 WHERE t_analysis_code = T13018.T_ANALYSIS_CODE AND t_ws_code = '10' ) END ) RES_VALUE_DES, TO_CHAR( t_upd_date,'dd/mm/yyyy')t_upd_date, TO_CHAR( t_entry_date,'dd/mm/yyyy')t_entry_date, t_upd_user, (SELECT t_user_name FROM t01009 WHERE t_emp_code = (SELECT MAX(t_upd_user) FROM t13018 WHERE t_request_no = '{reqNo}' AND t_ws_code ='10' AND t_result_value IS NOT NULL AND t_analysis_time=(select max(t_analysis_time) from t13018 where t_request_no='{reqNo}' AND t_result_value is not null) AND t_analysis_code BETWEEN '10039' AND '10077' ) ) REPORTED_BY, t_entry_user, (SELECT t_user_name FROM t01009 WHERE t_emp_code = T13018.T_ENTRY_USER ) PERFORM_BY, T_REQUEST_NO FROM T13018, T13064 WHERE T13018.T_ANALYSIS_CODE = T13064.T_ANALYSIS_CODE AND T13018.T_ANALYSIS_CODE BETWEEN '10039' AND '10080' AND T_REQUEST_NO ='{reqNo}' AND T_RESULT_VALUE IS NOT NULL AND T_CLOSE_FLAG IS NOT NULL");
        }
        public DataTable GetPatInfoData(string reqNo)
        {
            return ReportQuery($@"SELECT T_LOCATION_CODE , ( CASE WHEN (SELECT t_lang2_name FROM t02042 WHERE t_loc_code = T13015.T_LOCATION_CODE) IS NULL THEN (SELECT t_clinic_name_lang2 FROM t07001 WHERE t_clinic_code = T13015.T_LOCATION_CODE ) ELSE (SELECT t_lang2_name FROM t02042 WHERE t_loc_code = T13015.T_LOCATION_CODE ) END ) LOCATION_NAME, T_PAT_NO , ( CASE WHEN T_EXTERNAL_FLAG IS NULL THEN ( SELECT T_BIRTH_DATE FROM t03001 WHERE t03001.T_PAT_NO = T13015.T_PAT_NO ) ELSE ( SELECT T_BIRTH_DATE FROM t03003 WHERE t_TMP_PAT_NO = T13015.T_PAT_NO ) END )BIRTH_DATE , ( CASE WHEN T_EXTERNAL_FLAG IS NULL THEN (SELECT TRUNC ( (sysdate-T_BIRTH_DATE)/365,0) || ' ' || 'Y' || ' ' ||TRUNC(MOD(MONTHS_BETWEEN(sysdate,T_BIRTH_DATE), 12), 0) || ' ' ||'M' || ' ' || TRUNC ((sysdate) - add_months( T_BIRTH_DATE,TRUNC(months_between(TRUNC(sysdate),T_BIRTH_DATE)))) ||' ' ||'D' FROM t03001 WHERE t03001.T_PAT_NO =T13015.T_PAT_NO ) ELSE (SELECT TRUNC ( (sysdate-T_BIRTH_DATE)/365,0) || ' ' || 'Y' ||' ' || TRUNC(MOD(MONTHS_BETWEEN(sysdate,T_BIRTH_DATE), 12), 0) || ' ' ||'M' || ' ' ||TRUNC ((sysdate) - add_months( T_BIRTH_DATE,TRUNC(months_between(TRUNC(sysdate),T_BIRTH_DATE)))) ||' ' ||'D' FROM t03003 WHERE t_TMP_PAT_NO = T13015.T_PAT_NO ) END ) T_AGE , ( CASE WHEN T_EXTERNAL_FLAG IS NULL THEN (SELECT T_FIRST_LANG2_NAME ||' ' ||T_FATHER_LANG2_NAME ||' ' || T_GFATHER_LANG2_NAME ||' ' ||T_FAMILY_LANG2_NAME FROM t03001 WHERE t_pat_no = T13015.T_PAT_NO ) ELSE (SELECT T_FIRST_LANG2_NAME ||' ' ||T_FATHER_LANG2_NAME ||' ' || T_GFATHER_LANG2_NAME ||' ' ||T_FAMILY_LANG2_NAME FROM t03003 WHERE t_tmp_pat_no = T13015.T_PAT_NO ) END ) pat_name_eng, ( CASE WHEN T_EXTERNAL_FLAG IS NULL THEN (SELECT T_FIRST_LANG1_NAME ||' ' ||T_FATHER_LANG1_NAME ||' ' || T_GFATHER_LANG1_NAME ||' ' ||T_FAMILY_LANG1_NAME FROM t03001 WHERE t_pat_no = T13015.T_PAT_NO ) ELSE (SELECT T_FIRST_LANG1_NAME ||' ' ||T_FATHER_LANG1_NAME ||' ' || T_GFATHER_LANG1_NAME ||' ' ||T_FAMILY_LANG1_NAME FROM t03003 WHERE t_tmp_pat_no = T13015.T_PAT_NO ) END ) pat_name_arb, ( CASE WHEN T_EXTERNAL_FLAG IS NULL THEN (SELECT T02006.T_LANG2_NAME FROM t03001 t_pat JOIN t02006 ON t_pat.t_gender = T02006.T_SEX_CODE WHERE T_PAT_NO = T13015.T_PAT_NO ) ELSE (SELECT T02006.T_LANG2_NAME FROM t03003 t_pat JOIN t02006 ON t_pat.t_gender = T02006.T_SEX_CODE WHERE T_TMP_PAT_NO = T13015.T_PAT_NO ) END ) T_GENDER , ( CASE WHEN T_EXTERNAL_FLAG IS NULL THEN (SELECT T02003.T_LANG2_NAME FROM t03001 t_pat JOIN T02003 ON t_pat.t_NTNLTY_CODE = T02003.T_NTNLTY_CODE WHERE T_PAT_NO = T13015.T_PAT_NO ) ELSE (SELECT T02003.T_LANG2_NAME FROM t03003 t_pat JOIN T02003 ON t_pat.t_NTNLTY_CODE = T02003.T_NTNLTY_CODE WHERE T_TMP_PAT_NO = T13015.T_PAT_NO ) END ) T_NTNLTY , T_PAT_TYPE , T_PRIORITY_CODE , T_REQUEST_DATE , SUBSTR(T_REQUEST_TIME,1,2) || ': ' || SUBSTR(T_REQUEST_TIME ,3,2) REQUEST_TIME , DOCTOR_NAME(T_DOC_CODE ) PHYSICIAN_NAME , T_REQUEST_NO REQUEST_NO , T_CLINIC_DATA , T_EXTERNAL_FLAG , (SELECT TO_CHAR(T_COLLECTION_DATE,'dd/mm/YYYY') ||' ' ||T_COLLECTION_TIME FROM T13017 WHERE T_REQUEST_NO =T13015.T_REQUEST_NO AND T_WS_CODE ='10' AND T_ANALYSIS_CODE ='1004' AND TO_CHAR( T_COLLECTION_DATE ,'dd/mm/YYYY') ||' ' ||T_COLLECTION_TIME= (SELECT TO_CHAR(MAX(T_COLLECTION_DATE),'dd/mm/YYYY') ||' ' ||MAX(T_COLLECTION_TIME) FROM T13017 WHERE T13017.T_REQUEST_NO =T13015.T_REQUEST_NO GROUP BY T_COLLECTION_DATE ) )COLLECTION_DATE_TIME, (SELECT TO_CHAR(T_COLLECTION_DATE,'dd/mm/yyyy') FROM T13017 WHERE T_REQUEST_NO =T13015.T_REQUEST_NO AND T_WS_CODE ='10' AND T_ANALYSIS_CODE ='1004' AND TO_CHAR( T_COLLECTION_DATE ,'dd/mm/YYYY') ||' ' ||T_COLLECTION_TIME= (SELECT TO_CHAR(MAX(T_COLLECTION_DATE),'dd/mm/YYYY') ||' ' ||MAX(T_COLLECTION_TIME) FROM T13017 WHERE T13017.T_REQUEST_NO =T13015.T_REQUEST_NO GROUP BY T_COLLECTION_DATE ) ) REPORTED_DATE, (SELECT TO_CHAR(T_RECEIVED_DATE,'dd/mm/YYYY') ||' ' ||T_RECEIVED_TIME FROM T13017 WHERE T_REQUEST_NO =T13015.T_REQUEST_NO AND T_WS_CODE ='10' AND T_ANALYSIS_CODE ='1004' AND TO_CHAR( T_RECEIVED_DATE ,'dd/mm/YYYY') ||' ' ||T_RECEIVED_TIME= (SELECT TO_CHAR(MAX(T_RECEIVED_DATE),'dd/mm/YYYY') ||' ' ||MAX(T_RECEIVED_TIME) FROM T13017 WHERE T13017.T_REQUEST_NO =T13015.T_REQUEST_NO GROUP BY T_RECEIVED_DATE ) )RECEIVED_DATE_TIME, (SELECT T13005.t_lang2_name FROM T13017 JOIN T13005 ON T13017.T_SPECIMEN_CODE = T13005.t_specimen_code WHERE T13017.T_REQUEST_NO =T13015.T_REQUEST_NO AND T_WS_CODE ='10' AND T_ANALYSIS_CODE ='1004' AND TO_CHAR( T_COLLECTION_DATE ,'dd/mm/YYYY') ||' ' ||T_COLLECTION_TIME= (SELECT TO_CHAR(MAX(T_COLLECTION_DATE),'dd/mm/YYYY') ||' ' ||MAX(T_COLLECTION_TIME) FROM T13017 WHERE T13017.T_REQUEST_NO =T13015.T_REQUEST_NO GROUP BY T_COLLECTION_DATE ) ) SPECIMEN_DES, (SELECT MAX(T_LAB_NO) FROM T13017 WHERE T_REQUEST_NO = T13015.T_REQUEST_NO AND T_WS_CODE = '10' AND T_LAB_NO IS NOT NULL AND T_ANALYSIS_CODE ='1004' ) T_LAB_NO, T_SPEC_NO FROM T13015 WHERE T_REQUEST_NO = '{reqNo}' GROUP BY T_LOCATION_CODE , T_PAT_NO , T_PAT_TYPE , T_ENTRY_USER , T_PRIORITY_CODE , T_REQUEST_DATE , T_REQUEST_NO , T_CLINIC_DATA , T_EXTERNAL_FLAG , T_SPEC_NO , T_DOC_CODE , SUBSTR(T_REQUEST_TIME,1,2) || ': ' || SUBSTR(T_REQUEST_TIME ,3,2)");
        }
    }
}
